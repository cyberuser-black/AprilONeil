-- /proc/pid/maps example:

-- 7fb23c960000-7fb23c96b000 r-xp 00000000 00:00 187810             /lib/x86_64-linux-gnu/libnss_files-2.27.so
-- 7fb23c96b000-7fb23c96c000 ---p 0000b000 00:00 187810             /lib/x86_64-linux-gnu/libnss_files-2.27.so
-- 7fb23c96c000-7fb23cb6a000 ---p 0000c000 00:00 187810             /lib/x86_64-linux-gnu/libnss_files-2.27.so
-- 7fb23cb6a000-7fb23cb6b000 r--p 0000a000 00:00 187810             /lib/x86_64-linux-gnu/libnss_files-2.27.so
-- 7fb23cb6b000-7fb23cb6c000 rw-p 0000b000 00:00 187810             /lib/x86_64-linux-gnu/libnss_files-2.27.so
-- 7fb23cb6c000-7fb23cb72000 rw-p 00000000 00:00 0
-- 7fb23cb80000-7fb23cb97000 r-xp 00000000 00:00 187805             /lib/x86_64-linux-gnu/libnsl-2.27.so
-- 7fb23cb97000-7fb23cb98000 ---p 00017000 00:00 187805             /lib/x86_64-linux-gnu/libnsl-2.27.so
-- 7fb23cb98000-7fb23cd96000 ---p 00018000 00:00 187805             /lib/x86_64-linux-gnu/libnsl-2.27.so
-- 7fb23cd96000-7fb23cd97000 r--p 00016000 00:00 187805             /lib/x86_64-linux-gnu/libnsl-2.27.so
-- 7fb23cd97000-7fb23cd98000 rw-p 00017000 00:00 187805             /lib/x86_64-linux-gnu/libnsl-2.27.so
-- 7fb23cd98000-7fb23cd9a000 rw-p 00000000 00:00 0
-- 7fb23cda0000-7fb23cdab000 r-xp 00000000 00:00 187813             /lib/x86_64-linux-gnu/libnss_nis-2.27.so
-- 7fb23cdab000-7fb23cdac000 ---p 0000b000 00:00 187813             /lib/x86_64-linux-gnu/libnss_nis-2.27.so
-- 7fb23cdac000-7fb23cfaa000 ---p 0000c000 00:00 187813             /lib/x86_64-linux-gnu/libnss_nis-2.27.so
-- 7fb23cfaa000-7fb23cfab000 r--p 0000a000 00:00 187813             /lib/x86_64-linux-gnu/libnss_nis-2.27.so
-- 7fb23cfab000-7fb23cfac000 rw-p 0000b000 00:00 187813             /lib/x86_64-linux-gnu/libnss_nis-2.27.so
-- 7fb23cfb0000-7fb23cfb8000 r-xp 00000000 00:00 187806             /lib/x86_64-linux-gnu/libnss_compat-2.27.so
-- 7fb23cfb8000-7fb23cfba000 ---p 00008000 00:00 187806             /lib/x86_64-linux-gnu/libnss_compat-2.27.so
-- 7fb23cfba000-7fb23d1b8000 ---p 0000a000 00:00 187806             /lib/x86_64-linux-gnu/libnss_compat-2.27.so
-- 7fb23d1b8000-7fb23d1b9000 r--p 00008000 00:00 187806             /lib/x86_64-linux-gnu/libnss_compat-2.27.so
-- 7fb23d1b9000-7fb23d1ba000 rw-p 00009000 00:00 187806             /lib/x86_64-linux-gnu/libnss_compat-2.27.so
-- 7fb23d1c0000-7fb23d3a7000 r-xp 00000000 00:00 187792             /lib/x86_64-linux-gnu/libc-2.27.so
-- 7fb23d3a7000-7fb23d3b0000 ---p 001e7000 00:00 187792             /lib/x86_64-linux-gnu/libc-2.27.so
-- 7fb23d3b0000-7fb23d5a7000 ---p 001f0000 00:00 187792             /lib/x86_64-linux-gnu/libc-2.27.so
-- 7fb23d5a7000-7fb23d5ab000 r--p 001e7000 00:00 187792             /lib/x86_64-linux-gnu/libc-2.27.so
-- 7fb23d5ab000-7fb23d5ad000 rw-p 001eb000 00:00 187792             /lib/x86_64-linux-gnu/libc-2.27.so
-- 7fb23d5ad000-7fb23d5b1000 rw-p 00000000 00:00 0
-- 7fb23d5c0000-7fb23d5c3000 r-xp 00000000 00:00 187796             /lib/x86_64-linux-gnu/libdl-2.27.so
-- 7fb23d5c3000-7fb23d5c4000 ---p 00003000 00:00 187796             /lib/x86_64-linux-gnu/libdl-2.27.so
-- 7fb23d5c4000-7fb23d7c2000 ---p 00004000 00:00 187796             /lib/x86_64-linux-gnu/libdl-2.27.so
-- 7fb23d7c2000-7fb23d7c3000 r--p 00002000 00:00 187796             /lib/x86_64-linux-gnu/libdl-2.27.so
-- 7fb23d7c3000-7fb23d7c4000 rw-p 00003000 00:00 187796             /lib/x86_64-linux-gnu/libdl-2.27.so
-- 7fb23d7d0000-7fb23d7f5000 r-xp 00000000 00:00 180388             /lib/x86_64-linux-gnu/libtinfo.so.5.9
-- 7fb23d7f5000-7fb23d7fa000 ---p 00025000 00:00 180388             /lib/x86_64-linux-gnu/libtinfo.so.5.9
-- 7fb23d7fa000-7fb23d9f5000 ---p 0002a000 00:00 180388             /lib/x86_64-linux-gnu/libtinfo.so.5.9
-- 7fb23d9f5000-7fb23d9f9000 r--p 00025000 00:00 180388             /lib/x86_64-linux-gnu/libtinfo.so.5.9
-- 7fb23d9f9000-7fb23d9fa000 rw-p 00029000 00:00 180388             /lib/x86_64-linux-gnu/libtinfo.so.5.9
-- 7fb23da00000-7fb23da28000 r-xp 00000000 00:00 187783             /lib/x86_64-linux-gnu/ld-2.27.so
-- 7fb23da28000-7fb23da29000 r-xp 00028000 00:00 187783             /lib/x86_64-linux-gnu/ld-2.27.so
-- 7fb23da8e000-7fb23dc29000 r--p 00000000 00:00 142978             /usr/lib/locale/locale-archive
-- 7fb23dc29000-7fb23dc2a000 r--p 00029000 00:00 187783             /lib/x86_64-linux-gnu/ld-2.27.so
-- 7fb23dc2a000-7fb23dc2b000 rw-p 0002a000 00:00 187783             /lib/x86_64-linux-gnu/ld-2.27.so
-- 7fb23dc2b000-7fb23dc2c000 rw-p 00000000 00:00 0
-- 7fb23dd80000-7fb23dd83000 rw-p 00000000 00:00 0
-- 7fb23dd90000-7fb23dd92000 rw-p 00000000 00:00 0
-- 7fb23dd9b000-7fb23dda2000 r--s 00000000 00:00 211251             /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
-- 7fb23de00000-7fb23df03000 r-xp 00000000 00:00 144101             /bin/bash
-- 7fb23df03000-7fb23df04000 r-xp 00103000 00:00 144101             /bin/bash
-- 7fb23e103000-7fb23e107000 r--p 00103000 00:00 144101             /bin/bash
-- 7fb23e107000-7fb23e110000 rw-p 00107000 00:00 144101             /bin/bash
-- 7fb23e110000-7fb23e11a000 rw-p 00000000 00:00 0
-- 7fffe669c000-7fffe681f000 rw-p 00000000 00:00 0                  [heap]
-- 7fffed6ef000-7fffedeef000 rw-p 00000000 00:00 0                  [stack]
-- 7fffee504000-7fffee505000 r-xp 00000000 00:00 0                  [vdso]


-- output example:
-- 	{
-- 		offset=0,
-- 		address_range={
-- 			end_address=140737185247232,
-- 			start_address=140737176858624
-- 		},
-- 		inode=0,
-- 		pathname='[stack]',
-- 		device={
-- 			minor=0,
-- 			major=0
-- 		},
-- 		permissions={
-- 			execute=false,
-- 			read=true,
-- 			private=true,
-- 			write=true
-- 		}
-- 	},
-- 	{
-- 		offset=0,
-- 		address_range={
-- 			end_address=140737191628800,
-- 			start_address=140737191624704
-- 		},
-- 		inode=0,
-- 		pathname='[vdso]',
-- 		device={
-- 			minor=0,
-- 			major=0
-- 		},
-- 		permissions={
-- 			execute=true,
-- 			read=true,
-- 			private=true,
-- 			write=false
-- 		}
-- 	},
-- 	{
-- 	}
-- }
-- 	...

print("[Lua] [/proc/<pid>/maps] running...")

-- Add {PROJECT_DIR}/lua to LUA_PATH (assuming executable runs in {PROJECT_DIR}/cmake-build-debug)
package.path = package.path .. ";./lua/?.lua"
local cyberlib = require ('cyberlib') -- from {PROJECT_DIR}/lua/cyberlib.lua

name = "maps"

function parse(data)
    print("[Lua] [/proc/<pid>/maps] parse(data) "..name.."...")
    local parsed_data = cyberlib.parsers_helpers.parse_lines_to_lists_of_lists(data)
    local new_parsed_data = {}
    for line_number, list in pairs(parsed_data) do
        new_parsed_data[line_number] = {}
        -- parse address_range
        if list[1] ~= nil then
            local split_address_cell = cyberlib.utils.split(list[1], '-')
            new_parsed_data[line_number]['address_range'] = {}
            new_parsed_data[line_number]['address_range']['start_address'] = tonumber(split_address_cell[1], 16)
            new_parsed_data[line_number]['address_range']['end_address'] = tonumber(split_address_cell[2], 16)
        end

        -- parse permissions
        if list[2] ~= nil then
            new_parsed_data[line_number]['permissions'] = {}
            if cyberlib.lambdas.str_at(list[2], 1) == 'r' then
                new_parsed_data[line_number]['permissions']['read'] = true
            else
                new_parsed_data[line_number]['permissions']['read'] = false
            end
            if cyberlib.lambdas.str_at(list[2], 2) == 'w' then
                new_parsed_data[line_number]['permissions']['write'] = true
            else
                new_parsed_data[line_number]['permissions']['write'] = false
            end
            if cyberlib.lambdas.str_at(list[2], 3) == 'x' then
                new_parsed_data[line_number]['permissions']['execute'] = true
            else
                new_parsed_data[line_number]['permissions']['execute'] = false
            end
            if cyberlib.lambdas.str_at(list[2], 4) == 'p' then
                new_parsed_data[line_number]['permissions']['private'] = true
            else
                new_parsed_data[line_number]['permissions']['private'] = false
            end
        end

        -- parse offset
        if list[3] ~= nil then
            new_parsed_data[line_number]['offset'] = tonumber(list[3], 16)
        end

        -- parse dev
        if list[4] ~= nil then
            new_parsed_data[line_number]['device'] = {}
            local split_device_cell = cyberlib.utils.split(list[4], ':')
            new_parsed_data[line_number]['device']['major'] = cyberlib.lambdas.hexstrtodecnumber(split_device_cell[1])
            new_parsed_data[line_number]['device']['minor'] = cyberlib.lambdas.hexstrtodecnumber(split_device_cell[2])
        end

        -- parse inode
        if list[5] ~= nil then
            new_parsed_data[line_number]['inode'] = tonumber(list[5])
        end

        --parse pathname
        if list[6] ~= nil then
            new_parsed_data[line_number]['pathname'] = list[6]
        end
    end
    return new_parsed_data
end
